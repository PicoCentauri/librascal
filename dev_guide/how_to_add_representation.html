

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to add a new representation &mdash; Rascal 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/rascal.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to write a test" href="how_to_test.html" />
    <link rel="prev" title="How to edit the documentation" href="how_to_misc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rascal
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whitepaper.html">Goals &amp; Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOAP.html">SOAP Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../representation/representations.html">Representations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../neighbour_list/neighbour-list-manager.html">Neighbour List Manager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="how_to_contribute.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_misc.html">How to edit the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_misc.html#how-to-edit-a-readme">How to edit a Readme</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to add a new representation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#write-a-calculator-for-a-representation">Write a Calculator for a representation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementing-several-types-of-the-same-representation">Implementing several types of the same representation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#write-the-python-bindings-of-a-new-representation">Write the python bindings of a new representation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implement-and-test-gradients">Implement and test gradients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="how_to_test.html">How to write a test</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_test.html#running-the-tests">Running the tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_test.html#using-valgrind-to-check-for-memory-errors">Using Valgrind to check for memory errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding-convention.html">Coding Convention</a></li>
<li class="toctree-l2"><a class="reference internal" href="review_process.html">Review process</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark_tutorial.html">How to run benchmark for different parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark_tutorial.html#how-to-add-a-new-benchmark">How to add a new benchmark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rascal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developer.html">Developer’s guide</a> &raquo;</li>
        
      <li>How to add a new representation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_guide/how_to_add_representation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="contents local topic" id="contents">
<span id="how-to-add-representation"></span><ul class="simple">
<li><p><a class="reference internal" href="#how-to-add-a-new-representation" id="id5">How to add a new representation</a></p>
<ul>
<li><p><a class="reference internal" href="#write-a-calculator-for-a-representation" id="id6">Write a Calculator for a representation</a></p></li>
<li><p><a class="reference internal" href="#implementing-several-types-of-the-same-representation" id="id7">Implementing several types of the same representation</a></p></li>
<li><p><a class="reference internal" href="#write-the-python-bindings-of-a-new-representation" id="id8">Write the python bindings of a new representation</a></p></li>
<li><p><a class="reference internal" href="#implement-and-test-gradients" id="id9">Implement and test gradients</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="how-to-add-a-new-representation">
<h1><a class="toc-backref" href="#id5">How to add a new representation</a><a class="headerlink" href="#how-to-add-a-new-representation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="write-a-calculator-for-a-representation">
<h2><a class="toc-backref" href="#id6">Write a Calculator for a representation</a><a class="headerlink" href="#write-a-calculator-for-a-representation" title="Permalink to this headline">¶</a></h2>
<p>A calculator of a representation is an object that builds a representation of the atomic structure contained in <em>a</em> structure manager. This class:</p>
<ul class="simple">
<li><p>inherits publicly from <a class="reference internal" href="../reference/cpp.html#_CPPv4N6rascal14CalculatorBaseE" title="rascal::CalculatorBase"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CalculatorBase</span></code></a> to follow its interface and use some of the common utilies shared by such class.</p></li>
<li><p>uses a <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">compute()</span></code> function expecting one or a list of structure manager(s) to build the representation efficiently.</p></li>
<li><p>uses the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Property</span></code> class to store the representation’s features.</p></li>
</ul>
<p>The behaviour of a representation calculator is defined at construction by hyperparameters which are specific to the representation.
. These hyperparameters can</p>
<blockquote>
<div><ul class="simple">
<li><p>define a particular implementation from a set of conceptually equivalent methods, implemented using primitive enums</p></li>
<li><p>be scalar values or on/off features used as hyperparameters in the calculation of the represenation, implemented using primitive types</p></li>
</ul>
</div></blockquote>
<p>Note that there is one representation manager per structure manager.</p>
<p>To illustrate the basic structure that a new representation that would be implemented in <code class="docutils literal notranslate"><span class="pre">calculator_representation_name.hh</span></code> should follow, let’s take the example of the <a class="reference internal" href="../reference/cpp.html#_CPPv4N6rascal23CalculatorSortedCoulombE" title="rascal::CalculatorSortedCoulomb"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CalculatorSortedCoulomb</span></code></a>. A detailed discussion of the sorted coulomb matrix representation can be found in <a class="footnote-reference brackets" href="#one" id="id1">1</a> and <a class="footnote-reference brackets" href="#two" id="id2">2</a>.</p>
<p>The representation starts with the definition of some useful short hands</p>
<p>followed by the definition of its constructors and destructor</p>
<p>the declaration of the concrete implementation of the calculator interface</p>
<p>and the declaration of some functions for internal use in the protected section. The end of the class contains the different internal variables needed by the class</p>
</div>
<div class="section" id="implementing-several-types-of-the-same-representation">
<h2><a class="toc-backref" href="#id7">Implementing several types of the same representation</a><a class="headerlink" href="#implementing-several-types-of-the-same-representation" title="Permalink to this headline">¶</a></h2>
<p>Often there are different ways to implement the same fundamental representation. To be able to do this in rascal, the compute function is used with the type of of the implementation as template argument (or multiple if representation requires this). The switch between several implementations of conceptually equivalent parts of a representation can be implemented through several mechanisms such a virtual inheritance. We detail here how to implement such switch efficiently using the <a class="reference internal" href="../reference/cpp.html#_CPPv4N6rascal23CalculatorSortedCoulombE" title="rascal::CalculatorSortedCoulomb"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CalculatorSortedCoulomb</span></code></a> as an example.</p>
<p>To make the coulomb matrix invariant with respect to permutation Ref. <a class="footnote-reference brackets" href="#two" id="id3">2</a> proposes to sort the upper triangular part of the coulomb matrix according to the norm of each rows or the distance from the central atom (see <a class="footnote-reference brackets" href="#one" id="id4">1</a> for details).</p>
<p>The implementation of these two behaviour is encapsulated in the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SortCoulomMatrix</span></code> class and the choice between them is done with a template parameter using template specialization. Note that a in this particular case templated functions could be sufficient but to underline how to implement the most general case a class is used.</p>
<p>The specific implementation of the two options is done in with template specialization</p>
<p>The switch between the two behaviours is done in the <a class="reference internal" href="../reference/cpp.html#_CPPv4I0EN6rascal23CalculatorSortedCoulomb7computeEvR16StructureManager" title="rascal::CalculatorSortedCoulomb::compute"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">compute()</span></code></a> function which chooses the right type of computation method to compute the representation for each structure manager. At the moment the <a class="reference internal" href="../reference/cpp.html#_CPPv4I_N8internal15CMSortAlgorithmE0_NSt11enable_if_tIN8internal18is_proper_iteratorI16StructureManagerE5valueEiEEEN6rascal23CalculatorSortedCoulomb12compute_loopEvR16StructureManager" title="rascal::CalculatorSortedCoulomb::compute_loop"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">compute_loop()</span></code></a> function has to be copied to every new calculator to allow iterations over structure managers. It is not necessary to understand this code, if one is only interested to integegrate a new representation into rascal.</p>
<p>The actual implementation of the representation is in the function <a class="reference internal" href="../reference/cpp.html#_CPPv4I_N8internal15CMSortAlgorithmE0EN6rascal23CalculatorSortedCoulomb12compute_implEvRNSt10shared_ptrI16StructureManagerEE" title="rascal::CalculatorSortedCoulomb::compute_impl"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">compute_impl()</span></code></a> witch the computation method as template argument.</p>
</div>
<div class="section" id="write-the-python-bindings-of-a-new-representation">
<h2><a class="toc-backref" href="#id8">Write the python bindings of a new representation</a><a class="headerlink" href="#write-the-python-bindings-of-a-new-representation" title="Permalink to this headline">¶</a></h2>
<p>We use <code class="docutils literal notranslate"><span class="pre">pybind11</span></code> to handle the generation of python bindings. To make a new representation available for the use on the python side, you need to explicitly register your representation calculator for every possible structure manager stack that you want to make available in the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">add_representation_calculators()</span></code> function in <code class="docutils literal notranslate"><span class="pre">bindings/bind_py_representation_calculator.cc</span></code>. Here is an example on how it is done for the sorted coulomb representation.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>  <span class="c1">// Defines a particular structure manager type</span>

  <span class="k">using</span> <span class="n">TypeHolder_t</span> <span class="o">=</span>
      <span class="n">StructureManagerTypeHolder</span><span class="o">&lt;</span><span class="n">StructureManagerCenters</span><span class="p">,</span>
                                 <span class="n">AdaptorNeighbourList</span><span class="p">,</span> <span class="n">AdaptorStrict</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">ManagerList_t</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">TypeHolder_t</span><span class="o">::</span><span class="n">type_list</span><span class="p">;</span>
  <span class="c1">// using Manager_t = typename TypeHolder_t::type;</span>
  <span class="c1">// StructureManagerCenters,AdaptorNeighbourList, AdaptorStrict</span>
  <span class="c1">// Defines the representation manager type for the particular structure</span>
  <span class="c1">// manager</span>
  <span class="k">using</span> <span class="n">Calc1_t</span> <span class="o">=</span> <span class="n">CalculatorSortedCoulomb</span><span class="p">;</span>
  <span class="c1">// Bind the interface of this representation manager</span>
  <span class="k">auto</span> <span class="n">rep_sorted_coulomb</span> <span class="o">=</span>
      <span class="n">add_representation_calculator</span><span class="o">&lt;</span><span class="n">Calc1_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">m_internal</span><span class="p">);</span>
  <span class="n">bind_compute_function_helper</span><span class="o">&lt;</span><span class="n">ManagerList_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rep_sorted_coulomb</span><span class="p">);</span>
</pre></div>
</div>
<p>The last step is to write a python class in <code class="docutils literal notranslate"><span class="pre">bindings/rascal/representations/</span></code> to simplify the use of the representation from the python side. You can use the implentation of the <code class="xref py py-class docutils literal notranslate"><span class="pre">SortedCoulombMatrix</span></code> in the <code class="docutils literal notranslate"><span class="pre">coulomb_matrix.py</span></code> as a template.</p>
<dl class="footnote brackets">
<dt class="label" id="one"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id4">2</a>)</span></dt>
<dd><p><a class="reference external" href="http://www.qmlcode.org/qml.html#module-qml.representations">http://www.qmlcode.org/qml.html#module-qml.representations</a>.</p>
</dd>
<dt class="label" id="two"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id3">2</a>)</span></dt>
<dd><p>Rupp, M., Tkatchenko, A., Müller, K.-R., &amp; von Lilienfeld, O. A. (2011).
Fast and Accurate Modeling of Molecular Atomization Energies with Machine Learning.
Physical Review Letters, 108(5), 58301. <a class="reference external" href="https://doi.org/10.1103/PhysRevLett.108.058301">https://doi.org/10.1103/PhysRevLett.108.058301</a></p>
</dd>
</dl>
</div>
<div class="section" id="implement-and-test-gradients">
<h2><a class="toc-backref" href="#id9">Implement and test gradients</a><a class="headerlink" href="#implement-and-test-gradients" title="Permalink to this headline">¶</a></h2>
<p>In principle, all libRascal representations should implement gradients with
respect to the atomic positions.  Currently the only representations to do so
are the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SphericalExpansion</span></code> and <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SphericalInvariants</span></code>
(tensor order 0, body order 0–1 a.k.a. “RadialSpectrum” and “PowerSpectrum”) in
the GTO radial basis.  Until we come up with a general, standard way of
implementing gradients for any representation, please see those implementations
for guidance.</p>
<p>Once you’ve implemented the gradient – or derivative – of any function in
libRascal, you must test that it actually corresponds to the gradient of the
function that it purpots to be.  A finite-difference testing function is
provided for this purpose; see <a class="reference internal" href="how_to_test.html#testing-gradients"><span class="std std-ref">Testing gradients</span></a> for details.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="how_to_test.html" class="btn btn-neutral float-right" title="How to write a test" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="how_to_misc.html" class="btn btn-neutral float-left" title="How to edit the documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Chiheb Ben Mahmoud, Michele Ceriotti, Federico Giberti,
Klim Goldshtein, Till Junge, Markus Stricker, Félix Musil, Max Veit

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>