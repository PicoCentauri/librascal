

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to write a test &mdash; Rascal 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/rascal.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Coding Convention" href="coding-convention.html" />
    <link rel="prev" title="How to add a new representation" href="how_to_add_representation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rascal
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whitepaper.html">Goals &amp; Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOAP.html">SOAP Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../representation/representations.html">Representations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../neighbour_list/neighbour-list-manager.html">Neighbour List Manager</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="how_to_contribute.html">How to contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_misc.html">How to edit the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_misc.html#how-to-edit-a-readme">How to edit a Readme</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_to_add_representation.html">How to add a new representation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to write a test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-boost-test">Writing a Boost test</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-boost-auto-test-case">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_AUTO_TEST_CASE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-boost-fixture-test-case-template">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_FIXTURE_TEST_CASE_TEMPLATE</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-binding-test">Writing a binding test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-gradients">Testing gradients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-run-the-tests">How to run the tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding-convention.html">Coding Convention</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark_tutorial.html">How to run benchmark for different parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark_tutorial.html#how-to-add-a-new-benchmark">How to add a new benchmark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rascal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developer.html">Developer’s guide</a> &raquo;</li>
        
      <li>How to write a test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev_guide/how_to_test.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="contents local topic" id="contents">
<span id="how-to-test"></span><ul class="simple">
<li><p><a class="reference internal" href="#how-to-write-a-test" id="id2">How to write a test</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-a-boost-test" id="id3">Writing a Boost test</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-a-boost-auto-test-case" id="id4">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_AUTO_TEST_CASE</span></code></a></p></li>
<li><p><a class="reference internal" href="#writing-a-boost-fixture-test-case-template" id="id5">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_FIXTURE_TEST_CASE_TEMPLATE</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#writing-a-binding-test" id="id6">Writing a binding test</a></p></li>
<li><p><a class="reference internal" href="#testing-gradients" id="id7">Testing gradients</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#how-to-run-the-tests" id="id8">How to run the tests</a></p></li>
</ul>
</div>
<div class="section" id="how-to-write-a-test">
<h1><a class="toc-backref" href="#id2">How to write a test</a><a class="headerlink" href="#how-to-write-a-test" title="Permalink to this headline">¶</a></h1>
<p>Every feature (e.g., functions, class methods and constructors, algorithms) needs its own unit test. Unit tests serve two main purposes, on the one hand, they allow test-driven development (I.e.,  you define a test case and your expected results, then develop your feature. Once you replicate the expected results, your feature is ready) and on the other hand, they help catching regressions, especially in combination with the continuous integration server (It runs all test cases after every commit, and complains if the change causes any of them to fail.</p>
<p><em>Rascal</em> uses the <a class="reference external" href="http://www.boost.org/doc/libs/1_66_0/libs/test/doc/html/index.html">boost unit testing framework</a> for unit tests of the C++ core library and <a class="reference external" href="https://docs.python.org/3/library/unittest.html">unittest module</a> of the Python standard library for Python binding tests.</p>
<p>It is instructive to go through the documentations and tutorials for both testing frameworks for details, as the following examples only serve as pointers in the right direction.</p>
<div class="section" id="writing-a-boost-test">
<h2><a class="toc-backref" href="#id3">Writing a Boost test</a><a class="headerlink" href="#writing-a-boost-test" title="Permalink to this headline">¶</a></h2>
<p>Tests can be added to any of the <code class="docutils literal notranslate"><span class="pre">test_*.cc</span></code> files in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder, or you can add a new file containing tests in a new file, as long as it follows the pattern <code class="docutils literal notranslate"><span class="pre">test_*.cc</span></code> (after adding a new file, you will have to run <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">.</span></code> in the build folder for CMake to pick up the modification).</p>
<p>A test file needs to have the following structure:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;tests.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">rascal</span> <span class="p">{</span>

  <span class="p">...</span> <span class="c1">// test cases go here</span>

<span class="p">}</span> <span class="c1">// rascal</span>
</pre></div>
</div>
<p>Any test case in such a file will be added to <em>Rascal</em>’ main test suite. It is recommended to group test cases that logically belong together in sub test suites using the <code class="docutils literal notranslate"><span class="pre">BOOST_AUTO_TEST_SUITE</span></code> macro. Imagine we write a new sub-suite called <code class="docutils literal notranslate"><span class="pre">tutorial_test</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;tests.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">rascal</span> <span class="p">{</span>

  <span class="n">BOOST_AUTO_TEST_SUITE</span><span class="p">(</span><span class="n">tutorial_test</span><span class="p">);</span>

  <span class="p">...</span> <span class="c1">// test cases go here</span>

  <span class="n">BOOST_AUTO_TEST_SUITE_END</span><span class="p">()</span>

<span class="p">}</span> <span class="c1">// rascal</span>
</pre></div>
</div>
<p>The most used types of test cases will very likely be <code class="docutils literal notranslate"><span class="pre">BOOST_AUTO_TEST_CASE</span></code> (for straight-forward test cases that do not share common code with other test cases) and <code class="docutils literal notranslate"><span class="pre">BOOST_FIXTURE_TEST_CASE_TEMPLATE</span></code> (for testing more involved features which require a setup phase and are parametrised by template parameters, see <a class="reference external" href="http://www.boost.org/doc/libs/1_66_0/libs/test/doc/html/boost_test/tests_organization/fixtures.html">Fixtures</a> for a detailed discussion)</p>
<div class="section" id="writing-a-boost-auto-test-case">
<h3><a class="toc-backref" href="#id4">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_AUTO_TEST_CASE</span></code></a><a class="headerlink" href="#writing-a-boost-auto-test-case" title="Permalink to this headline">¶</a></h3>
<p>This is as simple as running some function from the library and checking the results with <code class="docutils literal notranslate"><span class="pre">BOOST_TEST</span></code> (<a class="reference external" href="http://www.boost.org/doc/libs/1_63_0/libs/test/doc/html/boost_test/testing_tools/boost_test_universal_macro.html">here</a>), e.g.:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;tests.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;module.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">rascal</span> <span class="p">{</span>

  <span class="n">BOOST_AUTO_TEST_SUITE</span><span class="p">(</span><span class="n">tutorial_test</span><span class="p">);</span>

  <span class="n">BOOST_AUTO_TEST_CASE</span><span class="p">(</span><span class="n">f_test</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BOOST_TEST</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Should have been 2&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">BOOST_AUTO_TEST_SUITE_END</span><span class="p">()</span>

<span class="p">}</span> <span class="c1">// rascal</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-a-boost-fixture-test-case-template">
<h3><a class="toc-backref" href="#id5">Writing a <code class="docutils literal notranslate"><span class="pre">BOOST_FIXTURE_TEST_CASE_TEMPLATE</span></code></a><a class="headerlink" href="#writing-a-boost-fixture-test-case-template" title="Permalink to this headline">¶</a></h3>
<p>While the previous example was simple, it was also very limited. Frequently, we wish to test multiple properties and methods of an initialised class or data structure, and will do so for multiple template parameters. The following very contrived example creates a so-called templated <em>test fixture</em>, defines a list of template instantiations that we wish to test, and runs the test cases on each member of the list.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;tests.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/mpl/list.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">rascal</span> <span class="p">{</span>

  <span class="n">BOOST_AUTO_TEST_SUITE</span><span class="p">(</span><span class="n">tutorial_test</span><span class="p">);</span>

  <span class="c1">// creation of the test fixture. In practice, this structure would</span>
  <span class="c1">// contain data members (here `int val`) that correspond to some data</span>
  <span class="c1">// structure of rascal. The constructor (which is required to be a</span>
  <span class="c1">// *default constructor*, i.e., without parameters) initialises the</span>
  <span class="c1">//structure)</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">Dim</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">DemoTestFixture</span> <span class="p">{</span>

    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">(){</span><span class="k">return</span> <span class="n">Dim</span><span class="p">;}</span>

    <span class="n">DemoTestFixture</span><span class="p">()</span>
      <span class="o">:</span><span class="n">val</span><span class="p">{</span><span class="n">Dim</span><span class="p">}</span>
    <span class="p">{}</span>

    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// create a list of template instantiations to test:</span>
  <span class="k">using</span> <span class="n">fixtures</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">DemoTestFixture</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
                                    <span class="n">DemoTestFixture</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;&gt;</span><span class="p">;</span>

  <span class="c1">// declare a fixture test using the list</span>
  <span class="n">BOOST_FIXTURE_TEST_CASE_TEMPLATE</span><span class="p">(</span>
    <span class="n">templated_basic_fixture_test</span><span class="p">,</span> <span class="n">Fix</span><span class="p">,</span> <span class="n">fixtures</span><span class="p">,</span> <span class="n">Fix</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BOOST_TEST</span><span class="p">(</span><span class="n">Fix</span><span class="o">::</span><span class="n">val</span> <span class="o">==</span> <span class="n">Fix</span><span class="o">::</span><span class="n">dim</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">BOOST_AUTO_TEST_SUITE_END</span><span class="p">()</span>

<span class="p">}</span> <span class="c1">// rascal</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-binding-test">
<h2><a class="toc-backref" href="#id6">Writing a binding test</a><a class="headerlink" href="#writing-a-binding-test" title="Permalink to this headline">¶</a></h2>
<p>Similarly to the library tests, binding tests can be added to any of the <code class="docutils literal notranslate"><span class="pre">python_*.py</span></code> files in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder, or you can add a new file containing tests in a new file, as long as it follows the pattern <code class="docutils literal notranslate"><span class="pre">python_*.py</span></code> (after adding a new file, you will have to run <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">.</span></code> in the build folder for CMake to pick up the modification). Furthermore, if you add a new file (say, <code class="docutils literal notranslate"><span class="pre">python_tutorial_test.py</span></code>, you will have to import it in the main python test file <code class="docutils literal notranslate"><span class="pre">python_binding_tests.py</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">python_tutorial_test</span>
</pre></div>
</div>
<p>The basic unit test tool in Python’s <code class="docutils literal notranslate"><span class="pre">unittest</span></code> module is the <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> class. New test cases need to inherit from it, define a test case initialisation method <code class="docutils literal notranslate"><span class="pre">setUp(self)</span></code> and one or more test methods <code class="docutils literal notranslate"><span class="pre">test_*(self)</span></code>. Say we create a new test case to test the distance matrix calculation function <code class="docutils literal notranslate"><span class="pre">cdist</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">python_import_rascal</span> <span class="kn">import</span> <span class="n">_rascal</span> <span class="k">as</span> <span class="n">pt</span>

<span class="k">class</span> <span class="nc">TestCdist</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;builds the test case. we&#39;ll use it to create the matrices</span>
<span class="sd">        coordinate matrices A and B between which we wish to compute</span>
<span class="sd">        the distances</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
        <span class="n">nb_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>
        <span class="n">nb_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># the distance matrix is trivial to compute:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dists_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nb_A</span><span class="p">,</span> <span class="n">nb_B</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_A</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_B</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dists_ref</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>


    <span class="k">def</span> <span class="nf">test_cdist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;feeds the matrices A and B to rascal&#39; cdist function and compares</span>
<span class="sd">        the results to the local reference dist_ref</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dists</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dists_ref</span><span class="p">)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertLessEqual</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-gradients">
<span id="id1"></span><h2><a class="toc-backref" href="#id7">Testing gradients</a><a class="headerlink" href="#testing-gradients" title="Permalink to this headline">¶</a></h2>
<p>All representations in libRascal should plan to implement gradients (derivatives
w.r.t. the Cartesian positions of all the atoms) so that they can be used to run
dynamics.  This is often a complex and error-prone task, so a finite-difference
gradient checker is provided to check the gradients of any representation
calculator – or any mathematical function in general – and ensure that the
analytical and finite-difference gradients match up.</p>
<p>To check the gradient of a new representation calculator, it should suffice to
use the classes RepresentationCalculatorGradientProvider (to provide the function
and its gradient) and RepresentationCalculatorGradientFixture (to assist in
iterating over the atoms of the structure).  An example of its usage is shown
below, excerpted from <code class="file docutils literal notranslate"><span class="pre">tests/test_calculator.cc</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">RepresentationCalculatorGradientProvider</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Fix</span><span class="o">::</span><span class="n">Representation_t</span><span class="p">,</span>
                                         <span class="k">typename</span> <span class="n">Fix</span><span class="o">::</span><span class="n">Manager_t</span><span class="o">&gt;</span>
    <span class="n">provider</span><span class="p">(</span><span class="n">representations</span><span class="p">.</span><span class="n">back</span><span class="p">(),</span> <span class="n">manager</span><span class="p">,</span> <span class="n">structures</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
<span class="n">RepresentationCalculatorGradientFixture</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Fix</span><span class="o">::</span><span class="n">Representation_t</span><span class="p">,</span>
                                        <span class="k">typename</span> <span class="n">Fix</span><span class="o">::</span><span class="n">Manager_t</span><span class="o">&gt;</span>
    <span class="n">grad_fix</span><span class="p">(</span><span class="s">&quot;reference_data/spherical_expansion_gradient_test.json&quot;</span><span class="p">,</span>
             <span class="n">manager</span><span class="p">,</span> <span class="n">provider</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
  <span class="n">test_gradients</span><span class="p">(</span><span class="n">grad_fix</span><span class="p">.</span><span class="n">get_provider</span><span class="p">(),</span> <span class="n">grad_fix</span><span class="p">);</span>
  <span class="n">grad_fix</span><span class="p">.</span><span class="n">advance_center</span><span class="p">();</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">grad_fix</span><span class="p">.</span><span class="n">has_next</span><span class="p">());</span>
</pre></div>
</div>
<p>where <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">representations.back()</span></code> is a
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RepresentationCalculator</span></code>,
<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">manager</span></code> is a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">StructureManager</span></code>, and
<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">structures.back()</span></code> is the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">AtomicStructure</span></code> associated with
that manager.</p>
<p>A more detailed documentation of these two classes follows:</p>
<dl class="class">
<dt id="_CPPv4I00EN6rascal6rascal40RepresentationCalculatorGradientProviderE">
<span class="target" id="classrascal_1_1RepresentationCalculatorGradientProvider"></span>template&lt;typename <code class="sig-name descname">Calculator</code>, class <code class="sig-name descname">StructureManager</code>&gt;<br /><em class="property">class </em><code class="sig-name descname">RepresentationCalculatorGradientProvider</code><a class="headerlink" href="#_CPPv4I00EN6rascal6rascal40RepresentationCalculatorGradientProviderE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Gradient provider specialized to testing the gradient of a Calculator</p>
<p>The gradient is tested center-by-center, by iterating over each center and doing finite displacements on its position. This iteration should normally be done by the <a class="reference internal" href="#classrascal_1_1RepresentationCalculatorGradientFixture"><span class="std std-ref">RepresentationCalculatorGradientFixture</span></a> class.</p>
<p>In the case of periodic structures, the gradient is accumulated only onto <em>real</em> atoms, but the motion of all <em>images</em> of the “moving” atom (the one with respect to which the gradient is being taken) is taken into account.</p>
<p>Initialize with a Calculator, a StructureManager, and an AtomicStructure representing the original structure (before modifying with finite-difference displacements). The gradient of the representation with respect to the center position can then be tested, as usual, with <a class="reference internal" href="#namespacerascal_1ad71f0429eaaaa417ce3cc942c67b7d3d"><span class="std std-ref">test_gradients()</span></a> (defined in test_math.hh). </p>
</dd></dl>

<dl class="class">
<dt id="_CPPv4I00EN6rascal6rascal39RepresentationCalculatorGradientFixtureE">
<span class="target" id="classrascal_1_1RepresentationCalculatorGradientFixture"></span>template&lt;typename <code class="sig-name descname">Calculator</code>, class <code class="sig-name descname">StructureManager</code>&gt;<br /><em class="property">class </em><code class="sig-name descname">RepresentationCalculatorGradientFixture</code> : <em class="property">public</em> rascal::<a class="reference internal" href="#_CPPv4N6rascal6rascal19GradientTestFixtureE" title="rascal::rascal::GradientTestFixture">GradientTestFixture</a><a class="headerlink" href="#_CPPv4I00EN6rascal6rascal39RepresentationCalculatorGradientFixtureE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Test fixture holding the gradient calculator and structure manager</p>
<p>Holds data (function values, gradient directions, verbosity) and iterates through the list of centers </p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric">Public Functions</p>
<dl class="function">
<dt id="_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture39RepresentationCalculatorGradientFixtureENSt6stringENSt10shared_ptrI16StructureManagerEER10Provider_t">
<span class="target" id="classrascal_1_1RepresentationCalculatorGradientFixture_1a0b6a081d4a8e5e2a9967672a1fabaf8d"></span><code class="sig-name descname">RepresentationCalculatorGradientFixture</code><span class="sig-paren">(</span>std::string <em>filename</em>, std::shared_ptr&lt;StructureManager&gt; <em>structure</em>, Provider_t &amp;<em>calc</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture39RepresentationCalculatorGradientFixtureENSt6stringENSt10shared_ptrI16StructureManagerEER10Provider_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Initialize a gradient test fixture</p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">filename</span></code>: JSON file holding gradient test parameters, format documented in <a class="reference internal" href="#classrascal_1_1GradientTestFixture"><span class="std std-ref">GradientTestFixture</span></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">structure</span></code>: StructureManager on which to test</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calc</span></code>: RepresentationCalculator whose gradient is being tested </p></li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture14advance_centerEv">
<span class="target" id="classrascal_1_1RepresentationCalculatorGradientFixture_1a204f003e273d314e65b1d2005a84b44c"></span>void <code class="sig-name descname">advance_center</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture14advance_centerEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Go to the next center in the structure</p>
<p>Not (yet) implemented as iterator because that overcomplicates things </p>
</dd></dl>

</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric">Public Members</p>
<dl class="member">
<dt id="_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture12fd_error_tolE">
<span class="target" id="classrascal_1_1RepresentationCalculatorGradientFixture_1a8c73948b5aa4b743925cb7802fe2afc2"></span>double <code class="sig-name descname">fd_error_tol</code> = {1E-4}<a class="headerlink" href="#_CPPv4N6rascal6rascal39RepresentationCalculatorGradientFixture12fd_error_tolE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Increased error tolerance because some representations have quite large finite-difference truncation errors (and possibly numerical issues for very small displacements) </p>
</dd></dl>

</div>
</dd></dl>

<p>For testing the gradient of arbitrary functions <span class="math notranslate nohighlight">\(f: \mathbb{R}^m
\rightarrow \mathbb{R}^n\)</span>, the function <a class="reference internal" href="../reference/cpp.html#_CPPv4I00EN6rascal14test_gradientsEv18FunctionProvider_t13TestFixture_t" title="rascal::test_gradients"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">test_gradients()</span></code></a> is
provided:</p>
<dl class="function">
<dt id="_CPPv4I00EN6rascal6rascal14test_gradientsEv18FunctionProvider_t13TestFixture_t">
<span class="target" id="namespacerascal_1ad71f0429eaaaa417ce3cc942c67b7d3d"></span>template&lt;typename <code class="sig-name descname">FunctionProvider_t</code>, typename <code class="sig-name descname">TestFixture_t</code>&gt;<br />void <code class="sig-prename descclassname">rascal<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">test_gradients</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4I00EN6rascal6rascal14test_gradientsEv18FunctionProvider_t13TestFixture_t" title="rascal::rascal::test_gradients::FunctionProvider_t">FunctionProvider_t</a> <em>function_calculator</em>, <a class="reference internal" href="#_CPPv4I00EN6rascal6rascal14test_gradientsEv18FunctionProvider_t13TestFixture_t" title="rascal::rascal::test_gradients::TestFixture_t">TestFixture_t</a> <em>params</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4I00EN6rascal6rascal14test_gradientsEv18FunctionProvider_t13TestFixture_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Numerically verify that a given function and its gradient are consistent</p>
<p><p>The function_calculator object may be of any type, as long as it provides two functions, f() and grad_f(), to calculate the function and its gradient (derivative for functions with one input, Jacobian for functions with multiple outputs - the output dimension is expected to correspond to columns). Both functions must accept an Eigen::Vector, corresponding to the function input, of dimension determined in the data file (read by </p>
<a class="reference internal" href="#classrascal_1_1GradientTestFixture"><span class="std std-ref">GradientTestFixture</span></a>). This function additionally guarantees that f() will be called before grad_f() with the same input.<dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">function_calculator</span></code>: An object that provides both the function and its gradient</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>: Test fixture object, e.g a <a class="reference internal" href="#classrascal_1_1GradientTestFixture"><span class="std std-ref">GradientTestFixture</span></a> or something providing the same information (i.e. function_inputs, displacement_directions, n_arguments, and verbosity)</p></li>
</ul>
</dd>
</dl>
</p>
<p><dl class="simple">
<dt><strong>Note</strong></dt><dd><p>If the functions f() and grad_f() are designed to accept fixed-size vectors (i.e. if the size of the argument is known at compile time), be sure to define, in the FunctionProvider class, a <code class="docutils literal notranslate"><span class="pre">constexpr</span> <span class="pre">static</span> <span class="pre">size_t</span> <span class="pre">n_arguments</span></code> member with the size of the argument vector. This will ensure that the gradient tester uses the corresponding fixed-size Eigen vectors/matrices as inputs. </p>
</dd>
</dl>
</p>
</dd></dl>

<p>An example generalized gradient test fixture is provided by
<a class="reference internal" href="../reference/cpp.html#_CPPv4N6rascal19GradientTestFixtureE" title="rascal::GradientTestFixture"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GradientTestFixture</span></code></a>:</p>
<dl class="class">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixtureE">
<span class="target" id="classrascal_1_1GradientTestFixture"></span><em class="property">class </em><code class="sig-name descname">GradientTestFixture</code><a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixtureE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Fixture for testing the gradient of a real function of N real arguments</p>
<p>(Verifies that the gradient is the same as the converged value of the finite-difference approximation along the given directions)</p>
<p>Parameters should be provided in a JSON input file, as follows:</p>
<p><dl class="simple">
<dt><strong>Parameters</strong></dt><dd><ul class="breatheparameterlist simple">
<li><p><code class="docutils literal notranslate"><span class="pre">function_inputs</span></code>: List of vectors of function arguments at which to test the gradient</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">direction_mode</span></code>: How the finite-difference directions are specified; options are “Cartesian” (once along each independent argument), “Random” (exactly what it says on the tin), and “Provided” (given in input file, see below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">displacement_directions</span></code>: List of vectors along which to displace the inputs, in case “direction_mode” is “Provided”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verbosity</span></code>: Level of verbosity to use when printing test info, as string (“NORMAL”, “INFO”, or “DEBUG”) </p></li>
</ul>
</dd>
</dl>
</p>
<p>Subclassed by <a class="reference internal" href="#classrascal_1_1RepresentationCalculatorGradientFixture"><span class="std std-ref">rascal::RepresentationCalculatorGradientFixture&lt; Calculator, StructureManager &gt;</span></a></p>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric">Public Types</p>
<dl class="enum">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixture14VerbosityValueE">
<span class="target" id="classrascal_1_1GradientTestFixture_1a2461ac0eb169ff614982e6a3f880b1cf"></span><em class="property">enum </em><code class="sig-name descname">VerbosityValue</code><a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixture14VerbosityValueE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Levels of verbosity for the gradient test </p>
<p><em>Values:</em></p>
<dl class="enumerator">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixture6NORMALE">
<span class="target" id="classrascal_1_1GradientTestFixture_1a2461ac0eb169ff614982e6a3f880b1cfa1e23852820b9154316c7c06e2b7ba051"></span><code class="sig-name descname">NORMAL</code> = 0<a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixture6NORMALE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Print nothing </p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixture4INFOE">
<span class="target" id="classrascal_1_1GradientTestFixture_1a2461ac0eb169ff614982e6a3f880b1cfa551b723eafd6a31d444fcb2f5920fbd3"></span><code class="sig-name descname">INFO</code> = 10<a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixture4INFOE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Print one line of info for each gradient step </p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixture5DEBUGE">
<span class="target" id="classrascal_1_1GradientTestFixture_1a2461ac0eb169ff614982e6a3f880b1cfadc30ec20708ef7b0f641ef78b7880a15"></span><code class="sig-name descname">DEBUG</code> = 20<a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixture5DEBUGE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Print as much as possible </p>
</dd></dl>

</dd></dl>

</div>
<div class="breathe-sectiondef docutils container">
<p class="breathe-sectiondef-title rubric">Public Members</p>
<dl class="member">
<dt id="_CPPv4N6rascal6rascal19GradientTestFixture12fd_error_tolE">
<span class="target" id="classrascal_1_1GradientTestFixture_1a0a64d8d81bb9ae4419c22d0e8588adea"></span>double <code class="sig-name descname">fd_error_tol</code> = {1E-6}<a class="headerlink" href="#_CPPv4N6rascal6rascal19GradientTestFixture12fd_error_tolE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The error of the finite-difference against the analytical derivatives isn’t going to be arbitrarily small, due to the interaction of finite-difference and finite precision effects. The default here reflects this, while allowing different tests to change it  keeping in mind that the automated test is really more intended to be a sanity check on the implementation than a rigorous convergence test. </p>
</dd></dl>

</div>
</dd></dl>

</div>
</div>
<div class="section" id="how-to-run-the-tests">
<h1><a class="toc-backref" href="#id8">How to run the tests</a><a class="headerlink" href="#how-to-run-the-tests" title="Permalink to this headline">¶</a></h1>
<p>All tests are added as targets during  compilation by default. You can run all tests by executing <code class="docutils literal notranslate"><span class="pre">ctest</span></code> in the build folder. If the tests fail, you can re-run them verbosely using <code class="docutils literal notranslate"><span class="pre">ctest</span> <span class="pre">-V</span></code> to get a detailed account of which tests have failed.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="coding-convention.html" class="btn btn-neutral float-right" title="Coding Convention" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="how_to_add_representation.html" class="btn btn-neutral float-left" title="How to add a new representation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Chiheb Ben Mahmoud, Michele Ceriotti, Federico Giberti,
Klim Goldshtein, Till Junge, Markus Stricker, Félix Musil, Max Veit

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>