<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Felix Musil" />
  <title>SOAP Derivation</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">SOAP Derivation</h1>
<p class="author">Felix Musil</p>
</header>
<h1 id="from-the-density-to-the-density-expansion">From the density to the density expansion</h1>
<p>Density expansion: <span class="math display">\[\rho^{\alpha}_i(\mathbf{r})=\sum_{j\in \alpha} \mathcal{N}_{\sigma}\left(\mathbf{r}-\mathbf{r}_{ij}\right) = 
\sum_{nlm} \braket{\alpha n \ell m}{\CX_i} B_{nlm}(\mathbf{r}),\]</span> where <span class="math inline">\(\alpha\)</span> is a tag refers to the specie of the considered atoms, <span class="math inline">\(\sum_{j \in \alpha}\)</span> defines a sum over the neighbours of atom <span class="math inline">\(i\)</span> of specie <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\mathcal{N}_{\sigma}\)</span> a Gaussian centered around <span class="math inline">\(0\)</span> and variance <span class="math inline">\(\sigma^2\)</span>, <span class="math inline">\(B_{nlm}(\mathbf{r}) = R_n(r) Y_{\ell}^m(\hat{\mathbf{r}})\)</span> defines a complete orthonormal basis set, <span class="math inline">\(Y_{\ell}^m\)</span> a spherical harmonic (SH), <span class="math inline">\(r=\norm{\mathbf{r}}\)</span> and <span class="math inline">\(\hat{\mathbf{r}}=\mathbf{r}/r\)</span>.</p>
<p>The following derivation aims at deriving expressions for the coefficients of the density expansion and their derivative with respect to atomic coordinate for several basis sets.</p>
<h2 id="density-coefficients-angular-integration">Density coefficients: angular integration</h2>
<p>Spherical harmonics are the only orthonormal basis set of <span class="math inline">\(S^2\)</span> so this part should apply except for real space basis.</p>
<p>We use the orthonormality of the basis set to compute the expressiont for the density coefficients and express the resulting integral over <span class="math inline">\(\rm I\!R^3\)</span> in spherical coordinates using <span class="math inline">\(\norm{\mathbf{r}-\mathbf{r}_{ij}}^2=\mathbf{r}^2+\mathbf{r}_{ij}^2-2\norm{\mathbf{r}}\norm{\mathbf{r}_{ij}}\cos{\theta}\)</span>: <span class="math display">\[\begin{split}
\braket{\alpha n \ell m}{\CX_i}=&amp; \sum_{j \in \alpha} c^{ij}_{n \ell m} = \sum_{j \in \alpha} \int_{\rm I\!R^3} \exp\left[-a\left(\mathbf{r}-\mathbf{r}_{ij}\right)^2\right]B_{nlm}(\mathbf{r})\\
=&amp;\sum_{j \in \alpha} \int_{0}^{\infty}r^2  \exp\left[-a\left(r^2+r_{ij}^2\right)\right] g_n(r) \int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \\ 
&amp; \int_0^{2\pi}\mathrm{d}\phi \exp\left[2arr_{ij}\cos{\theta}\right]Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\bm{q}}\right),\\
\end{split}\]</span> where <span class="math inline">\(\hat{\mathrm{R}} = \hat{\mathrm{R}}_{ZYZ}\left(\alpha_{ij},\beta{ij},0\right)\)</span> is the ZYZ-Euler matrix that rotate <span class="math inline">\(\hat{e}_z\)</span> onto <span class="math inline">\(\bm{q}_{ij}\)</span>, <span class="math inline">\(a=\frac{1}{2\sigma^2}\)</span>. Note that global normalization constants are omitted because of a normalization at the end.</p>
<p>We use the following convention for the SH <span class="math display">\[Y_{\ell}^{m}\left(\hat{\mathbf{r}}\right)=Y_{\ell}^{m}\left(\theta,\phi\right)=A_{\ell}^{m}e^{im\phi}P^{m}_{\ell}\left(\cos\theta\right),\]</span> where <span class="math inline">\(A_{\ell}^{m} =\sqrt{\frac{(\ell-m)!(2l+1)}{4\pi(\ell+m)!}}\)</span> and <span class="math inline">\(\hat{q}\)</span> is the direction vector defined by the angle <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\phi\)</span>. Note that the phase factor <span class="math inline">\((-1)^\ell\)</span> is included in the definition of the Associated Legendre Polynomials (ALPs). The set of spherical harmonics is calculated in the<br />
<strong>librascal/src/math/spherical_harmonics.cc</strong> file, which is provided with explanations. The total number of SH in the set is <span class="math inline">\((l_{max} +1)^2\)</span>.</p>
<p>The integration over the angular part yields <span class="math display">\[\begin{split}
\int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \exp\left[arr_{ij}\cos{\theta}\right] \int_0^{2\pi}\mathrm{d}\phi Y_{\ell}^{m}\left(\hat{\mathrm{R}}\left(\alpha_{ij},\beta{ij},0\right)\hat{\bm{q}}\right) =&amp; 4\pi Y_\ell^m \left(\beta_{ij},\alpha_{ij}\right) \mathsf{i}_{\ell}\left(arr_{ij}\right), \\
=&amp; Y_\ell^m \left(\hat{\mathbf{r}}_{ij}\right) \mathsf{i}_{\ell}\left(arr_{ij}\right),
\end{split}\]</span> where <span class="math inline">\(\mathsf{i}_{\ell}\)</span> stands for the modified spherical Bessel function of the first kind. The intermediate steps are detailed in the following paragraphs.</p>
<h4 id="integration-over-phi">Integration over <span class="math inline">\(\phi\)</span></h4>
<p>The integration over the polar angle cancels out all orders of <span class="math inline">\(m\)</span> from the SH <span class="math display">\[\int_0^{2\pi}\mathrm{d}\phi Y_{\ell}^{m}\left(\theta,\phi\right) = \sqrt{\pi\left(2l+1\right)}\mathrm{P}_{\ell}^{m}\left(\cos{\theta}\right) \delta_{m0},\]</span> since</p>
<p><span class="math display">\[\begin{split}
\int_0^{2\pi}\mathrm{d}\phi \exp\left[im\phi\right] = 2\pi \delta_{0m}.
\end{split}\]</span></p>
<p>Nevertheless, the rotation of the spherical harmonic breaks down into a linear combination of spherical harmonics. The coefficents are the entries of the Wigner D-matrix constructed from the Euler angles of the rotation matrix <span class="math inline">\(\hat{R}\)</span>. <span class="math display">\[\begin{split}
Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\mathbf{r}}\right) = &amp; \sum_{m&#39;=-\ell}^{\ell} \mathrm{D}_{mm&#39;}^\ell\left(\hat{R}\,\right) Y_{\ell}^{m}\left(\hat{\mathbf{r}}\right), \\
\mathrm{D}_{m0}^\ell\left(\alpha,\beta,\gamma\right) =&amp; \sqrt{\frac{4\pi}{2l+1}} Y_l^m\left(\beta,\alpha\right). \\
\end{split}\]</span></p>
<p>Thus, the polar integral over the rotated SH simplifies into <span class="math display">\[\begin{split}
\int_0^{2\pi}\mathrm{d}\phi\, Y_{\ell}^{m}\left(\hat{\mathrm{R}}\hat{\mathbf{r}}\right) =&amp; \sum_{m&#39;=-\ell}^{\ell} \mathrm{D}_{mm&#39;}^\ell\left(\alpha_{ij},\beta_{ij},0\right) \sqrt{\pi(2l+1)} P_{\ell}^{m&#39;}\left(\cos{\theta}\right) \delta_{m&#39;0} \\
=&amp; 2\pi Y_\ell^m \left(\beta_{ij},\alpha_{ij}\right) P_{\ell}^{0}\left(\cos{\theta}\right).
\end{split}
\label{eq:int-phi}\]</span></p>
<h4 id="integration-over-theta">Integration over <span class="math inline">\(\theta\)</span></h4>
<p>The modified spherical Bessel function of the first kind (MSBF) admit the following integral representation</p>
<p><span class="math display">\[\mathsf{i}_n\left(z\right)= \frac{1}{2}\int_{-1}^{1}\mathrm{d}x \exp\left(zx\right)\mathrm{P}_{n}^{0}\left(x\right),\]</span> which can be shown using the reference relations <a href="#eq:bessel-1,eq:bessel-3,eq:bessel-4" data-reference-type="ref" data-reference="eq:bessel-1,eq:bessel-3,eq:bessel-4">[eq:bessel-1,eq:bessel-3,eq:bessel-4]</a> <span class="math display">\[\begin{aligned}
\mathsf{j}_n\left(z\right) =&amp; \frac{(-i)^n}{2}\int_{-1}^{1}\mathrm{d}x \exp\left[izx\right]P_{n}^{0}\left(x\right),\footnotemark[1] \label{eq:bessel-1}\\
\mathsf{i}_n\left(z\right)=&amp; (-i)^{n} \mathsf{j}_n\left(iz\right),\footnotemark[2] \label{eq:bessel-3}\\
\mathsf{i}_n\left(z\right)=&amp; (-1)^{n} \mathsf{i}_n\left(-z\right),\footnotemark[3] \label{eq:bessel-4}\end{aligned}\]</span></p>



<p><span class="math inline">\(j_n\)</span> is the spherical Bessel function of the first kind. The integral over the polar angle is then given by <span class="math display">\[\begin{split}
\int_{-1}^{1}\mathrm{d}\left(\cos{\theta}\right) \exp\left[2arr_{ij}\cos{\theta}\right]P_{\ell}^{0}\left(\cos{\theta}\right) =&amp; 2 \mathsf{i}_{\ell}(2arr_{ij}). 
\end{split}\]</span></p>
<h2 id="density-coefficients-radial-integration">Density coefficients: Radial integration</h2>
<p>Summing up the results from the previous section: <span class="math display">\[c^{ij}_{n\ell m} = 4\pi Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right] \underbrace{\int_0^\infty \dd{r} r^2 R_n(r) e^{-ar^2} \mathsf{i}_{\ell}\left(2a r r_{ij}\right)}_{=\text{I}_{n\ell}^{ij}} ,\]</span> we identify <span class="math inline">\(\text{I}_{n\ell}^{ij}\)</span> as the last term to simplify for particular choices of radial basis functions.</p>
<h3 id="gto-like-radial-basis">GTO like radial basis</h3>
<p>The Gaussian Type Orbital radial basis is defined <span class="math display">\[R^{GTO}_{n}(r) = \mathcal{N}_n\ r^{n} \exp[-br^2],\]</span> where <span class="math inline">\(b=\frac{1}{2\sigma_n^2}\)</span>, <span class="math inline">\(\sigma_n = (r_\text{cut}-\delta r_\text{cut}) \max(\sqrt{n},1)/n_\text{max}\)</span> and the normalization factor is given by <span class="math display">\[\mathcal{N}_n^2 = \frac{2(1)}{\sigma_n^{2n + 3}\Gamma(n + 3/2)}.\]</span> The overlap between GTO radial basis is: <span class="math inline">\(\int_0^\infty R^{GTO}_{n}(r) R^{GTO}_{n^\prime}(r) \dd{r}= 2 \left(\frac{1}{2 \sigma_{n}^2}+\frac{1}{2 \sigma_{n^\prime}^2} \right)^{-\frac{1}{2} (3+n+n^\prime)} \Gamma(\frac{3+n+n^\prime}{2})\)</span> This equals what we use in the implementation <span class="math display">\[\int_0^\infty R^{GTO}_{n}(r) R^{GTO}_{n^\prime}(r) \dd{r}= N_n N_{n^\prime} \left(\frac{1}{2 \sigma_{n}^2}+\frac{1}{2 \sigma_{n^\prime}^2} \right)^{-\frac{1}{2} (3+n+n^\prime)} \Gamma(\frac{3+n+n^\prime}{2})\]</span></p>
<p>The radial integral becomes <span class="math display">\[I^{ij\,\text{GTO}}_{nl}= \mathcal{N}_n \frac{\sqrt{\pi}}{4} \frac{\Gamma\left(#1\right){\frac{n+\ell+k+3}{2}}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}}a^\ell r_{ij}^\ell(a+b)^{-\frac{n+k+\ell+3}{2}}  {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n+\ell+k+3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 r_{ij}^2}{a+b}},
    \label{eq:rad-int-gto-1}\]</span> which yields the following expression for the neighbour contribution</p>
<p><span class="math display">\[\begin{aligned}
    c^{ij\,\text{GTO}}_{n\ell m}=&amp; (\pi)^{\frac{3}{2}} \mathcal{N}_n \frac{\Gamma\left(#1\right){\frac{n+\ell+3}{2}}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}} (a+b)^{-\frac{n+\ell+3}{2}}  \\
    &amp; Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right]   (a\rij)^\ell  {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n+\ell+3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 \rij^2}{a+b}}.
    \label{eq:density-gto}\end{aligned}\]</span></p>
<p>where <span class="math inline">\(\Gamma\)</span> is the Gamma function, and <span class="math inline">\({}_1F_1\)</span> is the confluent hypergeometric function of the first kind.</p>
<p>The neighbour contribution is calculated in<br />
file <strong>librascal/src/representations/ representation_manager_spherical_expansion.hh</strong>,<br />
function <strong>compute_neighbour_contribution</strong>, line 338.</p>
<p>The steps of the derivation are detailed in the next paragraph.</p>
<h4 id="analytic-radial-integral">Analytic radial integral</h4>
<p>We write an integral representation of the confluent hypergeometric function <span class="math inline">\({}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{b}{z}\)</span> (CHF) in terms of MSBF: <span class="math display">\[{}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{\ell+\frac{3}{2}}{x} = \frac{2x^{-\frac{\ell}{2}}}{\sqrt{\pi}}\frac{\Gamma\left(#1\right){\ell+\frac{3}{2}}}{\Gamma\left(#1\right){a}}\int_0^\infty e^{-t} t^{a-1-\frac{\ell}{2}} \mathsf{i}_{\ell}(2\sqrt{xt})\dd{t},
\label{eq:chf-int}\]</span> using these relations</p>
<p><span class="math display">\[\begin{aligned}
{}_{1}F_{1}\left(#1 ,#2, #3 \right){a}{b}{z} = &amp; \frac{1}{\Gamma\left(#1\right){a}} \int_0^\infty e^{-t}t^{a-1}{}_{0}F_{1}\left(#1,#2\right){b}{zt}\dd{t},\footnotemark[9]\\
I_l(z) =&amp; \frac{(\frac{z}{2})^{\ell}}{\Gamma\left(#1\right){l+1}} {}_{0}F_{1}\left(#1,#2\right){\ell+1}{\frac{z^2}{4}},\footnotemark[10]\\
\mathsf{i}_{\ell}(z) =&amp; \sqrt{\frac{\pi}{2z}}I_{\ell+1/2}(z),\footnotemark[11]\\
\mathsf{i}_{\ell}(z) =&amp; \sqrt{\frac{\pi}{4}}\frac{(\frac{z}{2})^{\ell}}{\Gamma\left(#1\right){\ell+\frac{3}{2}}} {}_{0}F_{1}\left(#1,#2\right){\ell+\frac{3}{2}}{\frac{z^2}{4}},\\
{}_{0}F_{1}\left(#1,#2\right){\ell+\frac{3}{2}}{xt}=&amp; \sqrt{\frac{4}{\pi}}\Gamma\left(#1\right){\ell+\frac{3}{2}} x^{-\frac{\ell}{2}}t^{-\frac{\ell}{2}}\mathsf{i}_{\ell}(2\sqrt{xt}),\end{aligned}\]</span></p>
<p>where <span class="math inline">\(I_\ell\)</span> is the modified Bessel function and <span class="math inline">\({}_{0}F_{1}\left(#1,#2\right){b}{z}\)</span> is the limit conflent hypergeometric function.</p>
<p>The module for calculating <span class="math inline">\({}_{1}F_{1}\left(#1 ,#2, #3 \right){..}{..}{..}\)</span> is located in <strong>librascal/src/math/hyp1f1.hh</strong>.</p>
<p>The radial integral with GTO radial basis function is: <span class="math display">\[I^{ij\,\text{GTO}}_{nl}=\int_0^\infty \dd{r} r^{2+k} g^{\text{GTO}}_n(r) e^{-\frac{r^2}{2\sigma^2}} \mathsf{i}_{\ell}\left(r r_{ij} / \sigma^2\right) = \mathcal{N}_n \int_0^\infty \mathrm{d}r r^{2+k+n}  e^{-r^2(a+b)} \mathsf{i}_{\ell}\left(2a r r_{ij}\right),
    \label{eq:rad-int-gto-0}\]</span> with <span class="math inline">\(k\)</span> an additional power of <span class="math inline">\(r\)</span> that will be non zero for the derivative. We partially identify the terms between <a href="#eq:chf-int" data-reference-type="ref" data-reference="eq:chf-int">[eq:chf-int]</a> and <a href="#eq:rad-int-gto-0" data-reference-type="ref" data-reference="eq:rad-int-gto-0">[eq:rad-int-gto-0]</a>: <span class="math display">\[\begin{aligned}
    t =&amp; r^2(a+b),\\
    \dd{t} =&amp; 2 r \dd{r} (a+b),\\
    x = &amp; \frac{a^2 \rij^2}{a+b},\end{aligned}\]</span> to change the integrand of the radial integral <span class="math display">\[I^{ij\,\text{GTO}}_{nl}= \mathcal{N}_n \int_0^\infty \frac{\dd{t}}{2(a+b)} (a+b)^{-\frac{n+k+1}{2}} t^{\frac{n+k+1}{2}}  e^{-t} \mathsf{i}_{\ell}\left(2\sqrt{xt}\right),
    \label{eq:rad-int-gto-01}\]</span> and identify the last term <span class="math display">\[\begin{aligned}
    a =&amp; \frac{n+\ell+k+3}{2}.\end{aligned}\]</span></p>
<h3 id="numerical-integration-of-the-radial-integral">Numerical Integration of the Radial Integral</h3>
<p>The numerical integration does not rely on a specific form of the radial basis <span class="math display">\[\text{I}_{n\ell}^{ij} = \sum_{k=1}^{K} \omega_k  r_k^2 R_n(r_k) e^{-ar_k^2} \mathsf{i}_{\ell}\left(2a r_k r_{ij}\right),\]</span> where the <span class="math inline">\(\omega_k\)</span> are the quadrature weights evaluated at the quadrature nodes <span class="math inline">\(r_k\)</span>. Depending on the quadrature rule, the following shifting formula is useful, <span class="math display">\[\int_a^b f(x)\,\dd{x} \approx \frac{b-a}{2} \sum_{i=1}^n w_i f\left(\frac{b-a}{2}x_i + \frac{a+b}{2}\right).\]</span></p>
<h4 id="discrete-variable-representation">Discrete Variable Representation</h4>
<p>In the special case of the the DVR radial basiswith Gauss-Legendre quadrature rule, the radial integral simplifies into: <span class="math display">\[\text{I}_{n\ell}^{ij} = \frac{r_c}{2} \sqrt{\omega_n} x_n^2 e^{-ax_n^2} \mathsf{i}_{\ell}\left(2a x_n r_{ij}\right),\]</span> where <span class="math inline">\(x_n=\frac{r_c}{2}r_n+\frac{r_c}{2}\)</span>.</p>

<h2 id="gradient-of-the-density-coefficients-with-respect-to-the-cartesian-coordinates">Gradient of the density coefficients with respect to the Cartesian coordinates</h2>
<p>The density coefficients can be split into 2 parts: one that depends on the choice of radial basis function (<span class="math inline">\(\text{I}_{n\ell}^{ij}\)</span>) and the rest: <span class="math display">\[c^{ij}_{n\ell m} =  Y_{\ell}^m(\hat{\mathbf{r}}_{ij}) \exp\left[-ar^2_{ij}\right] \text{I}_{n\ell}^{ij} =  D^{ij}_{\ell m} C^{ij} \text{I}_{n\ell}^{ij},\]</span></p>
<p>where <span class="math inline">\(C^{ij}\)</span> is the Gaussian exponential factor and <span class="math inline">\(\bar{D}^{ij}_{\ell m} = \bar{Y}_{\ell,m}(\hat{r}_{ij})\)</span> is the spherical harmonic, see eq. <a href="#eq:real-spherical-harmonics" data-reference-type="eqref" data-reference="eq:real-spherical-harmonics">[eq:real-spherical-harmonics]</a>. Note the constant factors are omitted.</p>
<p>The following derivations end up with this formula that does not depend on the radial basis: <span class="math display">\[\begin{aligned}
    \grad_i\,c^{ij}_{\alpha n \ell m} =&amp; 2a c^{ij}_{\alpha n \ell m} \mathbf{r}_{ij}\nonumber\\
    &amp;{} +  C \bar{D}^{ij}_{\ell m} \cdot \grad_i \text{I}_{n\ell}^{ij}\nonumber\\
    &amp;{} + N_{n \ell}A_{n\ell} B_\ell C \cdot \grad_i\,\bar{D}^{ij}_{\ell,m},\end{aligned}\]</span> where <span class="math inline">\(\grad_i\bar{D}^{ij}_{\ell,m} = \grad_i \bar{Y}_{\ell,m}(\hat{r}_{ij})\)</span> is defined in <a href="#eq:dbx0,eq:dbx1,eq:dbx2,eq:dby0,eq:y1,eq:dby2,eq:dbz0,eq:dbz1,eq:dbz2" data-reference-type="ref" data-reference="eq:dbx0,eq:dbx1,eq:dbx2,eq:dby0,eq:y1,eq:dby2,eq:dbz0,eq:dbz1,eq:dbz2">[eq:dbx0,eq:dbx1,eq:dbx2,eq:dby0,eq:y1,eq:dby2,eq:dbz0,eq:dbz1,eq:dbz2]</a>.</p>
<h3 id="terms-common-to-the-different-radial-basis">Terms common to the different radial basis</h3>
<h4 id="gaussian">Gaussian</h4>
<p><span class="math display">\[\begin{gathered}
    \dv{C^{ij}}{r_{ij}} = -2ar_{ij}C^{ij}\end{gathered}\]</span></p>
<h4 id="length">Length</h4>
<p>So for the radial terms, we just use the derivatives of the radius <span class="math inline">\(r_{ij}\)</span> wrt the Cartesian coordinates: <span class="math display">\[\begin{gathered}
    \dv{ r_{ij}}{ \{x_i, y_i, z_i\}} = -\frac{\{x_{ij}, y_{ij}, z_{ij}\}}{r_{ij}}\\
    \grad_i\,r_{ij} = \frac{-\bvec{r}_{ij}}{r_{ij}}\\
    \text{where }\bvec{r}_{ij} = \bvec{r}_j - \bvec{r}_i\end{gathered}\]</span></p>
<h4 id="spherical-harmonics">Spherical Harmonics</h4>
<p>The derivative of the spherical harmonic can be expressed in a few different ways. The versions below are in terms of the original harmonic with possibly different <span class="math inline">\(m\)</span> values. The <span class="math inline">\(z\)</span> component is: <span class="math display">\[\begin{aligned}
    \frac{\partial D_{\ell m}}{\partial z_i} &amp;= \frac{-\sqrt{1-u^2}}{2r}\left(e^{i\phi}\sqrt{(\ell+m)(\ell-m+1)}Y_l^{m-1}(\hat{r})
        - e^{-i\phi}\sqrt{(\ell-m)(\ell+m+1)}Y_l^{m+1}(\hat{r})\right)\nonumber\\
    &amp;= \frac{-\sin{\theta}}{2r_{ij}}(\cos(m\phi) + i\sin(m\phi))
    \left(\sqrt{(\ell+m)(\ell - m + 1)}\sqrt{\frac{2\ell+1}{4\pi}\frac{(\ell-m+1)!}{(\ell+m-1)!}}
        P_l^{m-1}(\cos{\theta})\right.\nonumber\\
    &amp;\qquad\qquad \left. {} - \sqrt{(\ell-m)(\ell + m + 1)}\sqrt{\frac{2\ell+1}{4\pi}\frac{(\ell-m-1)!}{(\ell+m+1)!}}
    P_l^{m+1}(\cos{\theta})\right)\end{aligned}\]</span> But remember, we’re actually using the real spherical harmonics:</p>
<p><span id="eq:real-spherical-harmonics" label="eq:real-spherical-harmonics">[eq:real-spherical-harmonics]</span> <span class="math display">\[\begin{aligned}
    \left.\begin{aligned}
    \bar{Y}_{\ell m}(\hat{r}_{ij}) &amp;= \cos(m\phi) \bar{P}_\ell^m(\cos{\theta})\\
    \bar{Y}_{\ell,-m}(\hat{r}_{ij}) &amp;= \sin(m\phi) \bar{P}_\ell^m(\cos{\theta})
    \end{aligned}\right\}&amp;\text{ for }m &gt; 0\\
    \bar{Y}_{\ell,0}(\hat{r}_{ij}) = \frac{1}{\sqrt{2}} \bar{P}_\ell^0(\cos{\theta})&amp;\end{aligned}\]</span> where <span class="math display">\[\bar{P}_\ell^m(\cos{\theta}) = \sqrt{\frac{2\ell + 1}{2\pi}\frac{(\ell - m)!}{(\ell + m)!}}P_\ell^m(\cos{\theta}).\]</span></p>
<p>So we can write <span class="math display">\[\begin{aligned}
    \frac{\partial \bar{D}_{\ell m}}{\partial z_i} &amp;=
    \frac{-\sin\theta}{2r_{ij}}\cos(m\phi)\left(\sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)
        - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right) \label{eq:dbz0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial z_i} &amp;=
    \frac{-\sin\theta}{2r_{ij}}\sin(m\phi)\left(\sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)
        - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbz1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial z_i} &amp;= 
        \frac{\sin\theta}{r_{ij}}
            \sqrt{\frac{\ell(\ell + 1)}{2}}\bar{P}_\ell^{1}(\cos\theta))\label{eq:dbz2}\end{aligned}\]</span> (the last one comes from the identity <span class="math inline">\(\sqrt{\frac{(\ell+m)!}{(\ell-m)!}}P_\ell^{-m} = (-1)^m \sqrt{\frac{(\ell - m)!}{(\ell + m)!}}P_l^m(\cos\theta)\)</span> with <span class="math inline">\(m=1\)</span>).</p>
<p>The <span class="math inline">\(x\)</span> component is: <span class="math display">\[\begin{aligned}
    \frac{\partial \bar{D}_{\ell m}}{\partial x_i} &amp;= \frac{-m\sin\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,-m} + \frac{\cos\phi \cos\theta}{2r_{ij}}\cos(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &amp;\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbx0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial x_i} &amp;= \frac{m\sin\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,m} + \frac{\cos\phi \cos\theta}{2r_{ij}}\sin(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &amp;\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dbx1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial x_i} &amp;=
        \frac{-\cos\phi \cos\theta}{r_{ij}}\sqrt{\frac{\ell(\ell+1)}{2}}\bar{P}_\ell^1(\cos\theta)\label{eq:dbx2}\end{aligned}\]</span> and for the <span class="math inline">\(y\)</span> component, similarly: <span class="math display">\[\begin{aligned}
    \frac{\partial \bar{D}_{\ell m}}{\partial y_i} &amp;= \frac{m\cos\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,-m} + \frac{\sin\phi \cos\theta}{2r_{ij}}\cos(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &amp;\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dby0}\\
    \frac{\partial \bar{D}_{\ell,-m}}{\partial y_i} &amp;= \frac{-m\cos\phi}{\sqrt{x_{ij}^2 + y_{ij}^2}} \bar{D}_{\ell,m} + \frac{\sin\phi \cos\theta}{2r_{ij}}\sin(m\phi)\left(
        \sqrt{(\ell + m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta)\right.\nonumber\\
        &amp;\qquad\qquad\qquad\left. {} - \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\label{eq:dby1}\\
    \frac{\partial \bar{D}_{\ell,0}}{\partial y_i} &amp;=
        \frac{-\sin\phi \cos\theta}{r_{ij}}\sqrt{\frac{\ell(\ell+1)}{2}}\bar{P}_\ell^1(\cos\theta)\label{eq:dby2}\end{aligned}\]</span></p>
<p>The formulæ above have a singularity at the poles for <span class="math inline">\(m \neq 0\)</span>, so use the following identity: <span class="math display">\[\begin{gathered}
    \frac{m}{\sqrt{x_{ij}^2 + y_{ij}^2}} \begin{pmatrix}\bar{Y}_{\ell, -m}(\hat{r}_{ij})\\
                                                         \bar{Y}_{\ell,  m}(\hat{r}_{ij})\end{pmatrix}
        = \frac{-1}{2z_{ij}}\begin{pmatrix}\sin(m\phi)\\\cos(m\phi)\end{pmatrix}
            \left(\sqrt{(\ell+m)(\ell - m + 1)}\bar{P}_\ell^{m-1}(\cos\theta) \right.\\
            \left. {} + \sqrt{(\ell - m)(\ell + m + 1)}\bar{P}_\ell^{m+1}(\cos\theta)\right)\end{gathered}\]</span> to shift the singularity to the equator (<span class="math inline">\(z=0\)</span>). In the code derivatives of spherical harmonics is computed in the <strong>feat/soap_gradients branch</strong>, <strong>librascal/src/math/spherical_harmonics.hh</strong></p>
<h3 id="gto-like-radial-basis-1">GTO like radial basis</h3>
<p>We rewrite <a href="#eq:rad-int-gto-1" data-reference-type="ref" data-reference="eq:rad-int-gto-1">[eq:rad-int-gto-1]</a></p>
<p><span class="math display">\[I^{ij\,\text{GTO}}_{nl} = N_{n\ell} \cdot A_{n\ell} \cdot B_\ell ,\]</span> where <span class="math inline">\(B_{\ell} = r_{ij}^{\ell}\)</span>, <span class="math inline">\(A_{n\ell} = {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 3}{2}}{\ell+\frac{3}{2}}{\frac{a^2 r_{ij}^2}{a+b}}\)</span>, <span class="math inline">\(N_{n \ell} = \frac{\mathcal{N}_n}{4} a^\ell\left(a+b\right)^{-\frac{n + \ell + 3}{2}}  \frac{\Gamma\left(\frac{n + \ell + 3}{2}\right)}{\Gamma\left(\frac{3}{2} + \ell\right)}\)</span>, <span class="math inline">\(\mathcal{N}_n = \sqrt{\frac{2}{\sigma_n^{2n+3}\Gamma\left(n + \frac{3}{2}\right)}}\)</span>. Note that some constant multiplying factors of <span class="math inline">\(\pi\)</span> have been omitted.</p>
<h4 id="b_ell"><span class="math inline">\(B_{\ell}\)</span></h4>
<p><span class="math display">\[\dv{B_\ell}{r_{ij}} = \frac{\ell}{r_{ij}} B_\ell\]</span></p>
<h4 id="chf">CHF</h4>
<p>for the hypergeometric term: <span class="math display">\[\dv{A_{n \ell}}{r_{ij}} = \frac{\frac{n + \ell + 3}{2}}{\left(\ell + \frac{3}{2}\right)}
    \frac{2a^2 r_{ij}}{a+b}
    {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 5}{2}}{\ell+\frac{5}{2}}{\frac{a^2 r_{ij}^2}{a+b}}\]</span> which is not proportional to <span class="math inline">\(A_{n \ell}\)</span>, or even to <span class="math inline">\(A_{n+1,\ell + 1}\)</span> – so just recompute it explicitly.</p>
<h4 id="gto-formula-for-practical-computation">GTO formula for practical computation</h4>
<p>Finally, putting the radial and angular components together, we get: <span class="math display">\[\begin{aligned}
    \grad_i\,c^{ij}_{\alpha n \ell m} &amp;= c^{ij}_{\alpha n \ell m}\left(-\frac{\ell}{r_{ij}^2} + 2a\right)\mathbf{r}_{ij}\nonumber\\
    &amp;{} + N_{n \ell}B_\ell C \bar{D}_{\ell m} \cdot \frac{\frac{n + \ell + 3}{2}}{\left(\ell + \frac{3}{2}\right)}
    \frac{2a^2}{a+b}
    {}_{1}F_{1}\left(#1 ,#2, #3 \right){\frac{n + \ell + 5}{2}}{\ell+\frac{5}{2}}{\frac{a^2 r_{ij}^2}{a+b}} \bvec{r}_{ij}\nonumber\\
    &amp;{} + N_{n \ell}A_{n\ell} B_\ell C \cdot \nabla_i\,\bar{D}_{\ell,m}\end{aligned}\]</span> where the gradient of the spherical harmonic has already been computed separately using the equations above.</p>
<p>Gradient of the coefficients is calculated in <strong>feat/soap_gradients</strong> branch,<br />
file <strong>librascal/src/representations/representation_manager_spherical_expansion.hh</strong>,<br />
function <strong>compute_neighbour_derivative</strong>, line 420.</p>
<h3 id="numerical-integration">Numerical Integration</h3>
<p>Using the recurrence relation of the MSBF: <span class="math display">\[\dv{\mathsf{i}_{\ell}(x)}{x} = \frac{1}{2\ell+1}[\ell\mathsf{i}_{\ell-1}(x)+(\ell+1)\mathsf{i}_{\ell+1}(x)],\]</span> the gradient of the radial integral becomes: <span class="math display">\[\grad_i \text{I}_{n\ell}^{ij} = -\frac{2a}{2\ell+1}\sum_{k=1}^{K} \omega_k  r_k^3 R_n(r_k) e^{-ar_k^2} [\ell\mathsf{i}_{\ell-1}(2a r_k r_{ij})+(\ell+1)\mathsf{i}_{\ell+1}(2a r_k r_{ij})] \hat{\mathbf{r}}_{ij}.\]</span></p>
<p>In the case of the DVR radial basis:</p>
<p><span class="math display">\[\text{I}_{n\ell}^{ij} = -\frac{2a\sqrt{\omega_n}}{2\ell+1}\frac{r_c}{2}  x_n^3 e^{-ax_n^2} [\ell\mathsf{i}_{\ell-1}(2a x_n r_{ij})+(\ell+1)\mathsf{i}_{\ell+1}(2a x_n r_{ij})] \hat{\mathbf{r}}_{ij},\]</span> where <span class="math inline">\(x_n=\frac{r_c}{2}r_n+\frac{r_c}{2}\)</span>.</p>
</body>
</html>
