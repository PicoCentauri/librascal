

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>&lt;no title&gt; &mdash; Rascal 0.0.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/rascal.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to build a neighbor list?" href="nl-for-user.html" />
    <link rel="prev" title="Energy fitting" href="TutorialEn.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Rascal
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whitepaper.html">Goals &amp; Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SOAP.html">SOAP Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../representation/representations.html">Representations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../neighbor_list/neighbor-list-manager.html">Neighbor List Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/developer.html">Developer’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rascal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/SOAP_CSD500.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<dl>
<dt>{</dt><dd><dl>
<dt>“cells”: [</dt><dd><dl>
<dt>{</dt><dd><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“To install rascal:n”,
“(NOTE: See the top-level README for the most up-to-date installation instructions.)n”,
“+ mkdir ../build n”,
“+ cd buildn”,
“+ cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON ..n”,
“+ make -j 4n”,
“+ make install”</p>
</div></blockquote>
<p>]</p>
</dd>
</dl>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Setup”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“%matplotlib notebookn”,
“from matplotlib import pylab as pltn”,
“import os, sys”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“tags”: [</dt><dd><p>“hide_input”</p>
</dd>
</dl>
<p>]</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# Ensure the notebook is running in the proper directoryn”,
“# (only needed when compiling from sphinx)n”,
“if “docs/source/tutorials” in os.getcwd():n”,
”    os.chdir(“../../../examples”)n”,
“sys.path.insert(0,”../build/”)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import timen”,
“import rascaln”,
“import jsonn”,
“n”,
“import asen”,
“from ase.io import read, writen”,
“from ase.build import make_supercelln”,
“from ase.visualize import viewn”,
“import numpy as npn”,
“import sysn”,
“#import pandasn”,
“import scipyn”,
“import jsonn”,
“n”,
“from rascal.representations import SphericalInvariants as SOAP”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“import sklearn”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## Download data”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“Run the cell below to dowload the CSD-500 dataset you’ll need for this tutorial.n”,
“n”,
“The data is from the paper “Chemical shifts in molecular solids by machine learning” by Paruzzo, Hofstetter, Musil, De, Ceriotti and Emsley, available [here](<a class="reference external" href="https://www.nature.com/articles/s41467-018-06972-x">https://www.nature.com/articles/s41467-018-06972-x</a>). (If the cell below doesn’t work, try downloading “Supplementary Data 2” from the [supplementary info section](<a class="reference external" href="https://www.nature.com/articles/s41467-018-06972-x#Sec11">https://www.nature.com/articles/s41467-018-06972-x#Sec11</a>) of the paper; be sure to name it <cite>data/CSD-500.xyz</cite> as below).”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“download_link = “<a class="reference external" href="https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06972-x/MediaObjects/41467_2018_6972_MOESM4_ESM.txt">https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06972-x/MediaObjects/41467_2018_6972_MOESM4_ESM.txt</a>”n”,
“import urllib.requestn”,
“urllib.request.urlretrieve(download_link, ‘./reference_data/CSD-500.xyz’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“#frames = read(‘./data/small_molecules-1000.xyz’,’:600’)n”,
“frames = read(‘./reference_data/CSD-500.xyz’,’:3’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“n_atoms = sum(frame.get_number_of_atoms() for frame in frames)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“chem_shifts = []n”,
“for frame in frames:n”,
”    chem_shifts.append(frame.arrays[‘CS’])”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“chem_shifts[1].shape”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“chem_shifts_atoms = np.concatenate(chem_shifts, axis=0)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“chem_shifts_atoms.shape”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# SOAP: Power spectrum”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“code_folding”: []</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“hypers = dict(soap_type=”PowerSpectrum”,n”,
”              interaction_cutoff=3.5, n”,
”              max_radial=6, n”,
”              max_angular=6, n”,
”              gaussian_sigma_constant=0.4,n”,
”              gaussian_sigma_type=”Constant”,n”,
”              cutoff_smooth_width=0.5,n”,
”              )n”,
“soap = SOAP(<a href="#id1"><span class="problematic" id="id2">**</span></a>hypers)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“%time representation = soap.transform(frames)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“X = representation.get_features</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“X.shape”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Learning the chemical shifts of a set of crystal structures”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {</p>
<blockquote>
<div><p>“heading_collapsed”: true</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“## learning utilities”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“code_folding”: [</dt><dd><p>13,
20,
31,
33,
35,
37,
47,
54</p>
</dd>
</dl>
<p>],
“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def compute_representation(representation, frames):n”,
”    result = representation.transform(frames)n”,
”    return resultn”,
“n”,
“#def compute_representation(frames):n”,
“#    expansions = soap.transform(frames)n”,
“#    return expansionsn”,
“n”,
“def compute_atomic_kernel(zeta, rep1, rep2=None):n”,
”    if rep2 is not None:n”,
”        kernel = rep1.cosine_kernel_atomic(rep2, zeta)n”,
”    else:n”,
”        kernel = rep1.cosine_kernel_atomic(zeta)n”,
”    return kerneln”,
“n”,
“def extract_energy(frames):n”,
”    prop = [[]]*len(frames)n”,
”    for ii,cc in enumerate(frames):n”,
”        #prop[ii] = cc.info[‘dft_formation_energy_per_atom_in_eV’]n”,
”        prop[ii] = cc.info[‘ENERGY’]n”,
”    y = np.array(prop)n”,
”    return yn”,
“n”,
“def split_dataset(frames, test_fraction, seed=10):n”,
”    N = len(frames)n”,
”    ids = np.arange(N)n”,
”    np.random.seed(seed)n”,
”    np.random.shuffle(ids)n”,
”    Ntrain = int(N*test_fraction)n”,
”    train = ids[:Ntrain]n”,
”    test = ids[Ntrain:]n”,
”    targets = extract_energy(frames)n”,
”    return [frames[ii] for ii in train],targets[train],[frames[ii] for ii in test],targets[test]n”,
“n”,
“def get_mae(ypred,y):n”,
”    return np.mean(np.abs(ypred-y))n”,
“def get_rmse(ypred,y):n”,
”    return np.sqrt(np.mean((ypred-y)**2))n”,
“def get_sup(ypred,y):n”,
”    return np.amax(np.abs((ypred-y)))n”,
“def get_r2(y_pred,y_true):n”,
”    weight = 1n”,
”    sample_weight = Nonen”,
”    numerator = (weight * (y_true - y_pred) ** 2).sum(axis=0,dtype=np.float64)n”,
”    denominator = (weight * (y_true - np.average(n”,
”        y_true, axis=0, weights=sample_weight)) ** 2).sum(axis=0,dtype=np.float64)n”,
”    output_scores = 1 - (numerator / denominator)n”,
”    return np.mean(output_scores)n”,
“n”,
“n”,
“score_func = dict(n”,
”    MAE=get_mae,n”,
”    RMSE=get_rmse,n”,
”    SUP=get_sup,n”,
”    R2=get_r2,n”,
“)n”,
“n”,
“def get_score(ypred,y):n”,
”    scores = {}n”,
”    for k,func in score_func.items():n”,
”        scores[k] = func(ypred,y)n”,
”    return scoresn”,
“n”,
“class KRR(object):n”,
”    def __init__(self,zeta,weights,representation,X):n”,
”        self.weights = weightsn”,
”        self.representation = representationn”,
”        self.zeta = zetan”,
”        self.X = Xn”,
”        n”,
”    def predict(self,frames):n”,
”        features = compute_representation(self.representation,frames)n”,
”        kernel = compute_atomic_kernel(self.zeta, self.X, features)n”,
”        return np.dot(self.weights, kernel)n”,
“n”,
“def train_krr_model(zeta,Lambda,representation,frames,y,jitter=1e-8):n”,
”    features = compute_representation(representation, frames)n”,
”    kernel = compute_atomic_kernel(zeta, features, features)    n”,
”    # adjust the kernel so that it is properly scaledn”,
”    delta = np.std(y) / np.mean(kernel.diagonal())n”,
”    kernel[np.diag_indices_from(kernel)] += Lambda**2 / delta <a href="#id3"><span class="problematic" id="id4">**</span></a>2 + jittern”,
”    # train the krr modeln”,
”    weights = np.linalg.solve(kernel,y)n”,
”    model = KRR(zeta, weights,representation, features)n”,
”    return model,kerneln”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“compute_representation(soap, frames)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {</p>
<blockquote>
<div><p>“heading_collapsed”: true</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“## With the full power spectrum”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“hypers = dict(soap_type=”PowerSpectrum”,n”,
”              interaction_cutoff=3.5, n”,
”              max_radial=1, n”,
”              max_angular=1, n”,
”              gaussian_sigma_constant=0.4,n”,
”              gaussian_sigma_type=”Constant”,n”,
”              cutoff_smooth_width=0.5,n”,
”              )n”,
“soap = SOAP(<a href="#id5"><span class="problematic" id="id6">**</span></a>hypers)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“frames_train, y_train, frames_test, y_test = split_dataset(frames,0.5)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_train = np.concatenate([frame.arrays[‘CS’] for frame in frames_train], axis=0)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_train = y_train[:,0]”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_test = np.concatenate([frame.arrays[‘CS’] for frame in frames_test], axis=0)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_test = y_test[:,0]”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“n_atoms = sum(frame.get_number_of_atoms() for frame in frames_train)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“zeta = 2”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“features = compute_representation(soap, frames_train)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“features”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“kernel = compute_atomic_kernel(zeta, features, features)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“kernel.shape”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# WTF?n”,
“#for i in range(len(kernel)):n”,
“#    kernel[i][0] = np.sqrt(i)/50”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“kernel[191]”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# First, try without regularization – the results will be nonsensen”,
“weights = np.linalg.solve(kernel,y_train)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“weights.shape”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“model = KRR(zeta, weights, soap, features)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_pred = model.predict(frames_test)n”,
“get_score(y_pred, y_test)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“zeta = 2n”,
“Lambda = 10n”,
“krr,k = train_krr_model(zeta, Lambda, soap, frames_train, y_train)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_pred = krr.predict(frames_test)n”,
“get_score(y_pred, y_test)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“#sc = plt.scatter(y_pred, y_test, s=3)n”,
“#ax = plt.axis(‘scaled’)n”,
“plt.plot(y_test, y_pred, ‘.’)n”,
“plt.ylabel(‘DFT shift’)n”,
“plt.xlabel(‘Predicted shift’)n”,
“plt.savefig(‘R1.png’, dpi=300)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {</p>
<blockquote>
<div><p>“heading_collapsed”: true</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“## With just the radial spectrum”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“hypers = dict(soap_type=”RadialSpectrum”,n”,
”              interaction_cutoff=3.5, n”,
”              max_radial=6, n”,
”              max_angular=0, n”,
”              gaussian_sigma_constant=0.4,n”,
”              gaussian_sigma_type=”Constant”,n”,
”              cutoff_smooth_width=0.5n”,
”              )n”,
“soap = SOAP(<a href="#id7"><span class="problematic" id="id8">**</span></a>hypers)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“frames_train, y_train, frames_test, y_testr = split_dataset(frames,0.4)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“zeta = 2n”,
“Lambda = 5e-3n”,
“krr,k = train_krr_model(zeta, Lambda, soap, frames_train, y_train)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“y_predr = krr.predict(frames_test)n”,
“get_score(y_predr, y_testr)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“#plt.scatter(y_predr, y_testr, s=3)n”,
“#plt.scatter(y_predr, y_testr, s=3)n”,
“#ax = plt.axis(‘scaled’)n”,
“plt.plot(y_pred, y_test, ‘.b’)n”,
“plt.plot(y_predr, y_testr, ‘.y’)n”,
“plt.legend([‘Full’,’Radial’])n”,
“plt.ylabel(‘DFT energy / (eV/atom)’)n”,
“plt.xlabel(‘Predicted energy / (eV/atom)’)n”,
“plt.savefig(‘R1.png’, dpi=300)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“# Make a map of the dataset”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {</p>
<blockquote>
<div><p>“heading_collapsed”: true</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“## utils”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def compute_representation(representation,frames):n”,
”    expansions = soap.transform(frames)n”,
”    return expansionsn”,
“n”,
“def compute_kernel(zeta, rep1, rep2=None):n”,
”    if rep2 is None:n”,
”        kernel = rep1.cosine_kernel_global(zeta)n”,
”    else:n”,
”        kernel = rep1.cosine_kernel_global(rep2,zeta)n”,
”    return kernel”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“code_folding”: [</dt><dd><p>0</p>
</dd>
</dl>
<p>],
“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“def link_ngl_wdgt_to_ax_pos(ax, pos, ngl_widget):n”,
”    from matplotlib.widgets import AxesWidgetn”,
”    from scipy.spatial import cKDTreen”,
”    r”””n”,
”    Initial idea for this function comes from &#64;arose, the rest is &#64;gph82 and &#64;clonkern”,
”    “””n”,
”    n”,
”    kdtree = cKDTree(pos)        n”,
”    #assert ngl_widget.trajectory_0.n_frames == pos.shape[0]n”,
”    x, y = pos.Tn”,
”    n”,
”    lineh = ax.axhline(ax.get_ybound()[0], c=”black”, ls=’–’)n”,
”    linev = ax.axvline(ax.get_xbound()[0], c=”black”, ls=’–’)n”,
”    dot, = ax.plot(pos[0,0],pos[0,1], ‘o’, c=’red’, ms=7)n”,
“n”,
”    ngl_widget.isClick = Falsen”,
”    n”,
”    def onclick(event):n”,
”        linev.set_xdata((event.xdata, event.xdata))n”,
”        lineh.set_ydata((event.ydata, event.ydata))n”,
”        data = [event.xdata, event.ydata]n”,
”        _, index = kdtree.query(x=data, k=1)n”,
”        dot.set_xdata((x[index]))n”,
”        dot.set_ydata((y[index]))n”,
”        ngl_widget.isClick = Truen”,
”        ngl_widget.frame = indexn”,
”    n”,
”    def my_observer(change):n”,
”        r”””Here comes the code that you want to executen”,
”        “””n”,
”        ngl_widget.isClick = Falsen”,
”        _idx = change[“new”]n”,
”        try:n”,
”            dot.set_xdata((x[_idx]))n”,
”            dot.set_ydata((y[_idx]))            n”,
”        except IndexError as e:n”,
”            dot.set_xdata((x[0]))n”,
”            dot.set_ydata((y[0]))n”,
”            print(“caught index error with index %s (new=%s, old=%s)” % (_idx, change[“new”], change[“old”]))n”,
”    n”,
”    # Connect axes to widgetn”,
”    axes_widget = AxesWidget(ax)n”,
”    axes_widget.connect_event(‘button_release_event’, onclick)n”,
”    n”,
”    # Connect widget to axesn”,
”    ngl_widget.observe(my_observer, “frame”, “change”)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {</p>
<blockquote>
<div><p>“heading_collapsed”: true</p>
</div></blockquote>
<p>},
“source”: [</p>
<blockquote>
<div><p>“## make a map with kernel pca projection”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# Load the small molecules n”,
“frames = read(‘./reference_data/small_molecules-1000.xyz’,’:600’)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“hypers = dict(soap_type=”PowerSpectrum”,n”,
”              interaction_cutoff=3.5, n”,
”              max_radial=6, n”,
”              max_angular=6, n”,
”              gaussian_sigma_constant=0.4,n”,
”              gaussian_sigma_type=”Constant”,n”,
”              cutoff_smooth_width=0.5,n”,
”              )n”,
“soap = SOAP(<a href="#id9"><span class="problematic" id="id10">**</span></a>hypers)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“zeta = 2n”,
“n”,
“features = compute_representation(soap, frames)n”,
“n”,
“kernel = compute_kernel(zeta,features)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“from sklearn.decomposition import KernelPCA”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“kpca = KernelPCA(n_components=2,kernel=’precomputed’)n”,
“kpca.fit(kernel)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“X = kpca.transform(kernel)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {</p>
<blockquote>
<div><p>“hidden”: true</p>
</div></blockquote>
<p>},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“plt.scatter(X[:,0],X[:,1],s=3)n”,
“#plt.savefig(‘PCA.png’,dpi=300)”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “markdown”,
“metadata”: {},
“source”: [</p>
<blockquote>
<div><p>“## make an interactive map”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“# package to visualize the structures in the notebookn”,
“# <a class="reference external" href="https://github.com/arose/nglview#released-versionn">https://github.com/arose/nglview#released-versionn</a>”,
“import nglview”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“iwdg = nglview.show_asetraj(frames)n”,
“# set up the visualizationn”,
“iwdg.add_unitcell()n”,
“iwdg.add_spacefill()n”,
“iwdg.remove_ball_and_stick()n”,
“iwdg.camera = ‘orthographic’n”,
“iwdg.parameters = { “clipDist”: 0 }n”,
“iwdg.center()n”,
“iwdg.update_spacefill(radiusType=’covalent’,n”,
”                                   scale=0.6,n”,
”                                   color_scheme=’element’)n”,
“iwdg._remote_call(‘setSize’, target=’Widget’,n”,
”                               args=[‘%dpx’ % (600,), ‘%dpx’ % (400,)])n”,
“iwdg.player.delay = 200.0”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: [</p>
<blockquote>
<div><p>“link_ngl_wdgt_to_ax_pos(plt.gca(), X, iwdg)n”,
“plt.scatter(X[:,0],X[:,1],s=3)n”,
“iwdg”</p>
</div></blockquote>
<p>]</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: []</p>
</div></blockquote>
<p>},
{</p>
<blockquote>
<div><p>“cell_type”: “code”,
“execution_count”: null,
“metadata”: {},
“outputs”: [],
“source”: []</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>],
“metadata”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“kernelspec”: {</dt><dd><p>“display_name”: “Python 3”,
“language”: “python”,
“name”: “python3”</p>
</dd>
</dl>
<p>},
“language_info”: {</p>
<blockquote>
<div><dl class="simple">
<dt>“codemirror_mode”: {</dt><dd><p>“name”: “ipython”,
“version”: 3</p>
</dd>
</dl>
<p>},
“file_extension”: “.py”,
“mimetype”: “text/x-python”,
“name”: “python”,
“nbconvert_exporter”: “python”,
“pygments_lexer”: “ipython3”,
“version”: “3.7.5rc1”</p>
</div></blockquote>
<p>},
“toc”: {</p>
<blockquote>
<div><p>“base_numbering”: 1,
“nav_menu”: {</p>
<blockquote>
<div><p>“height”: “12px”,
“width”: “252px”</p>
</div></blockquote>
<p>},
“number_sections”: true,
“sideBar”: true,
“skip_h1_title”: false,
“title_cell”: “Table of Contents”,
“title_sidebar”: “Contents”,
“toc_cell”: false,
“toc_position”: {},
“toc_section_display”: “block”,
“toc_window_display”: false</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>},
“nbformat”: 4,
“nbformat_minor”: 2</p>
</dd>
</dl>
<p>}</p>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="nl-for-user.html" class="btn btn-neutral float-right" title="How to build a neighbor list?" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="TutorialEn.html" class="btn btn-neutral float-left" title="Energy fitting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Chiheb Ben Mahmoud, Michele Ceriotti, Federico Giberti,
Klim Goldshtein, Till Junge, Markus Stricker, Félix Musil, Max Veit

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>